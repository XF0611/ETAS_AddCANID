/*********************************************************************************************************************
*
* Description:     
* FileName:        EcuMgt.c
* Company:         ETAS GmbH (www.etas.com)
*
**********************************************************************************************************************
*
* COPYRIGHT RESERVED, Copyright ETAS GmbH 2021. All rights reserved, also regarding any disposal,
* exploitation, reproduction, editing, distribution, as well as in the event of applications
* for industrial property rights.
*
**********************************************************************************************************************
* History:
**********************************************************************************************************************
* Author        Date            Comment
**********************************************************************************************************************
UCN1HC          2021/25/12      initial commit
**********************************************************************************************************************/


/*********************************************************************************************************************
* Includes
*********************************************************************************************************************/
#include "EcuMgt.h"
#include "FBL_BootM.h"
//#include "FlsLoader.h"
#include "FBL_WdgM.h"
#include "arc_exception.h"
#include "Target.h"
#include "Mcal_Integration.h"
#include "xip_boot.h"

/*********************************************************************************************************************
* Local Defines
*********************************************************************************************************************/

/*********************************************************************************************************************
* Local Macros
*********************************************************************************************************************/

/*********************************************************************************************************************
* Local Types
*********************************************************************************************************************/

/*********************************************************************************************************************
* Local Variables
*********************************************************************************************************************/

/*********************************************************************************************************************
* Local Functions Prototypes
*********************************************************************************************************************/

/*********************************************************************************************************************
* Local Functions Implementation
*********************************************************************************************************************/

/*********************************************************************************************************************
* Exported Variables Implementation
*********************************************************************************************************************/

/*********************************************************************************************************************
* Exported Functions Implementation
*********************************************************************************************************************/

void EcuMgt_Init(void)                                                                              /* PRQA S 1503 */
{
    Mcu_Init(&Mcu_Config);
    Gpt_Init(&Gpt_Config);
    Target_Init(); /*Initialize Target */
    Port_Init(&Port_Config); /*Port initialization */
    Dio_Init(&Dio_Config);
	Dio_WriteChannel(DioConf_DioPort_0_DioChannel_11_Pin9, STD_HIGH);
	Dio_WriteChannel(DioConf_DioPort_1_DioChannel_2_Pin29, STD_HIGH);	    
    Fls_Init(&Fls_Config); /*Fls initialization */
    Can_Init(&Can_Config); /*Initialize CAN*/
    // Eth_Init(&EthConfigSet); /*Initialize Eth*/
    Fbl_WdgM_init(); /* Initialize Watchdog feature */
    Spi_Init(&SpiConfigData);

    EcuMgt_EnableAllInterrupt();                                            /* PRQA S 3200 */
    
    xip_boot(); /* BIP ARC porting for core runs on external flash */
   // FlsLoader_Init(NULL_PTR);                                               /* PRQA S 3200 */
}

void EcuMgt_PerformReset(void)                                              /* PRQA S 1503 */
{
    Mcu_PerformReset();
}

inline void EcuMgt_DisableAllInterrupt(void)                                /* PRQA S 1503, 1505 */
{                                                                           /* PRQA S 3243 */
    arc_lock();                                                             /* PRQA S 3200, 3335 */
}

inline void EcuMgt_EnableAllInterrupt(void)                                 /* PRQA S 1503 */
{                                                                           /* PRQA S 3243 */
    arc_unlock();                                                           /* PRQA S 3200, 3335 */
}

void EcuMgt_DoBoot(uint32 Address)                                          /* PRQA S 1503 */
{
    Fbl_WdgM_Disable();
    void (*JumpToApp)(void);
    EcuMgt_DisableAllInterrupt();                                                              /* PRQA S 3200 */
    JumpToApp = (void (*)(void)) Address;                                   /* PRQA S 0305 */
    JumpToApp();
}
